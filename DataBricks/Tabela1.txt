--Venda Mercadoria Resumo
Select
  DT_Cad,
  IF(Tp_Etg = 'SD', Filial_VV, 
  CASE 
     WHEN Tp_Etg = 'SL' THEN 'SAI LOJA' 
     WHEN Tp_Etg = 'RL'THEN 'RETIRA LOJA' 
     WHEN Tp_Etg = 'RD'THEN 'RETIRA DEPOSITO' 
     WHEN Tp_Etg = 'RM' THEN 'RETIRA HUB' 
     ELSE Tp_Etg
  END) as Filial_VV,
  Status,
  Tp_Etg,
  Plataforma,
  Modal,
  count(Documento) as Qtd_Ped, 
  Sum(Qtd_Cxs) as Qtd_Cxs, 
  Sum(Valor_Ped) as Valor_Ped 
  from(
    select
      DT_Cad,
      Documento,
      Filial_VV,
      Status,
      Tp_Etg,
      Plataforma,
      Modal,
      Sum(Qtd_Cxs) as Qtd_Cxs,
      Sum(Valor_Ped) as Valor_Ped 
      from (
    --Venda Mercadoria Resumo Caixas e Valor
      select
        DT_Cad,
        HR_Cad,
        Documento,
        Filial_VV,
        Status,
        Tp_Etg,
        Cod_Setor,
        Dsc_Setor,
        Plataforma,
        Modal,
        Sum(Qtd_Cxs) as Qtd_Cxs,
        Sum(Valor_Ped) as Valor_Ped
        from(
      -- Venda Mercadoria
        select
          a.dt_pvemcr_cad as DT_Cad,
          a.hr_pvemcr_cad as HR_Cad, 
          Concat(a.cd_pvemcr,a.cd_pvemcr_dsm) as Documento,
          if(a.cd_fil_dpo_etg in(14,1200,1401),
          if( a.cd_fil_dpo_etg = 14,'1401'||' '||IF(a.cd_zen IN ('Y','Q','K','W'),'LEVES','PESADOS'),
          a.cd_fil_dpo_etg||' '||IF(a.cd_zen IN ('Y','Q','K','W'),'LEVES','PESADOS')), a.cd_fil_dpo_etg) as Filial_VV,
          a.cd_fil_dpo_etg as Filial, 
          a.st_pvemcr as Status_PV,
          CASE 
            WHEN a.ST_PVEMCR = 1 THEN 'ABERTO' 
            WHEN a.ST_PVEMCR = 2 THEN 'ENCERRADO' 
            WHEN a.ST_PVEMCR = 3 THEN 'CANCELADO' 
            WHEN a.ST_PVEMCR = 4 THEN 'LIB. ENTREGA' 
            WHEN a.ST_PVEMCR = 5 THEN 'EM ENTREGA' 
            WHEN a.ST_PVEMCR = 6 THEN 'EM LOCALIZACAO' 
            WHEN a.ST_PVEMCR = 7 THEN 'DESMEMBRADO' 
            ELSE a.ST_PVEMCR 
          END AS STATUS,
          a.cd_tipetg as Tp_Etg,
          b.cd_mcr as sku,
          c.ds_mcr as descricao,
          c.cd_setmcr as Cod_Setor,
          d.Dsc_Setor,
          a.cd_fil_pto_vnd as Pto_Vnd,
          CONCAT(a.cd_est_sig_zen, a.cd_zen, right(CONCAT('000',a.cd_miczen),4)) as MicroZona, 
          a.cd_pvemcr_est_etg as UF_Cliente, if(a.cd_fil_pto_vnd > 5000,'ON','OFF') as Plataforma, 
          IF(a.cd_zen IN ('Y','Q','K','W'),'LEVES','PESADOS') as Modal, 
          b.qt_ipmcr_mcr as Qtd_Cxs, 
          b.vr_ipmcr_unt as Valor,
          b.qt_ipmcr_mcr * b.vr_ipmcr_unt as Valor_Ped

        from context_loja.pve_mcr as a
        left join context_loja.itm_pve_mcr as b
        ON left(a.cd_pvemcr,9) = b.cd_pvemcr
        left join context_loja.mcr as c 
        ON b.cd_mcr = c.cd_mcr
        left join (Select Setor, Dsc_Setor 
        from (
          Select *, 
            RANK() Over(PARTITION BY Setor order by ID2 asc) as ID3 
            from (select distinct 
            Setor, 
            Dsc_Setor ,
            if(Dsc_Setor in ('TELEFONIA CELULAR','ESPORTE','ESTOFADOS','MOVEIS SALA DE ESTAR','TELEFONIA FIXA'), 0, ID) as ID2
              from (
                select distinct 
                cd_setmcr as Setor, 
                Trim(ds_smaset) as Dsc_Setor, 
                dataingestao as Dt_Cad, 
                Rank() Over(
                partition by cd_setmcr
                order by dataingestao desc) as ID 
                from context_loja.set_mcr_agp_set)
              order by Setor, ID2))
          where ID3 = 1
        order by Setor) as d 
        On c.cd_setmcr = d.Setor 

        where
        --Selecionar periodo de DATA
        a.dt_pvemcr_cad >= '2022-01-01'
        --(a.dt_pvemcr_cad >= '2020-01-01' and a.dt_pvemcr_cad <= '2022-01-01')
        --and a.st_pvemcr != 7
        and a.cd_tipetg = 'SD'
      ) -- Fim resumo Caixas e Valor
      group by DT_Cad, HR_Cad, Documento, Filial_VV, Status, Tp_Etg, Cod_Setor, Dsc_Setor, Plataforma, Modal
      order by DT_Cad, HR_Cad, Documento, Filial_VV, Status, Tp_Etg, Cod_Setor, Dsc_Setor, Plataforma, Modal
    )-- Fim Resumo Pedido
    group by DT_Cad, Documento, Filial_VV, Status, Tp_Etg, Plataforma, Modal
    order by DT_Cad, Documento, Filial_VV, Status, Tp_Etg, Plataforma, Modal
  )-- Fim Resumo Pedido
--where Filial_VV = 1088 and Status = 'ENCERRADO' AND Plataforma = 'ON' and Modal = 'PESADOS'
group by DT_Cad, Filial_VV, Status, Tp_Etg, Plataforma, Modal
order by DT_Cad, Filial_VV, Status, Tp_Etg, Plataforma, Modal